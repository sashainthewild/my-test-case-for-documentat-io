---
title: "Как включить HTTPS на вашем сайте с nginx с помощью Let's Encrypt"
date: 2019-03-26T08:47:11+01:00
draft: false
---

# Как включить HTTPS на вашем сайте с nginx с помощью Let's Encrypt

[Let’s Encrypt](https://letsencrypt.org/) представляет собой некоммерческий центр сертификации (Certificate Authority, CA), позволяющий бесплатно получать, устанавливать и обновлять сертификаты TLS/SSL. Процесс получения сертификатов упрощается за счёт наличия ACME-клиента Certbot, который автоматизирует практически все необходимые операции.

Несмотря на то, что SSL-сертификаты Let’s Encrypt бесплатны — это не означает, что уровень их шифрования ниже, чем у платных сертификатов. Let’s Encrypt придерживается самых высоких стандартов шифрования и предлагает сертификаты высокого уровня надежности.

## Чем сертификаты Let’s Encrypt отличаются от платных сертификатов

**Стоимостью.** Let’s Encrypt не потребует денег ни за установку, ни за продление сертификата. Однако возможно сделать добровольное пожертвование на [сайте проекта](https://letsencrypt.org/ru/donate/).

**Скоростью и простотой установки.** Let's Encrypt в своей работе делает упор на автоматизацию абсолютно всех процессов. На типичном веб-сервере на базе Linux требуется выполнить несколько команд, которые настроят HTTPS-шифрование, получат и установят сертификат примерно за 20-30 секунд.

**Сроком действия.** Бесплатный сертификат Let’s Encrypt нельзя получить на год — только на 90 дней. Каждые три месяца его необходимо выпускать заново. Certbot поможет настроить автоматическое обновление.

**Совместимостью.** SSL-сертификаты Let’s Encrypt не работают в некоторых старых браузерах и операционных системах. Например, на компьютерах с Windows XP версии ниже SP3 или устройствах с Android версии ниже 2.3.6.

**Поддержкой**. У Let’s Encrypt нет службы поддержки, в которую можно обратиться, если появятся вопросы по установке или работе сертификата. Найти ответы можно в технической документации или на форуме.

## Перед установкой

Перед тем, как начать следовать описанным в этой статье шагам, убедитесь, что:

- на вашем сервере Ubuntu настроен доступ для не-рутового (non-root) пользователя с привилегиями `sudo` и доступом к настройке файрвола;

- для вашего сервера настроены обе записи DNS, указанные ниже;
    - Запись `A` для `documentat.io`, указывающая на публичный IP адрес вашего сервера;
    - Запись `A` для `www.documentat.io`, указывающая на публичный IP адрес вашего сервера.

- для вашего домена существует серверный блок. Ваш блок скорее всего будет выглядеть как `/etc/nginx/sites-available/documentat.io` .

Для получения бесплатного SSL сертификата и настройки автоматического продления этого сертификата мы будем использовать Certbot.

Также вместо файла по умолчанию мы будем использовать отдельный файл конфигурации сервера Nginx. Мы рекомендуем создавать новые файлы серверных блоков Nginx для каждого домена. Это поможет избежать распространённых ошибок и использовать дефолтные файлы в качестве примера корректной конфигурации, если что-нибудь пойдёт не так.

## Шаг 1. Установка Certbot

Перед началом использования Let’s Encrypt для получения SSL сертификаты установим Certbot на ваш сервер.

Установим Certbot и его плагин nginx с помощью `apt`:

```
$ sudo apt install certbot python3-certbot-nginx
```

Теперь Certbot готов к использованию, но для того, чтобы он мог настроить SSL для nginx, нам сперва необходимо проверить настройки nginx.

## Шаг 2. Настройка конфигурации Nginx

Чтобы настраивать SSL автоматически, Certbot необходимо найти правильный серверный блок в вашей конфигурации nginx. Для этого нужно найти директиву `server_name`, соответствующую домену, для которого вы запрашиваете сертификат.

Cерверный блок для вашего домена должен располагаться по адресу `/etc/nginx/sites-available/documentat.io` с уже настроенной директивой `server_name`

Для проверки откройте файл серверного блока в `nano` или любом другом текстовом редакторе:

```
$ sudo nano /etc/nginx/sites-available/documentat.io
```

Найдите строку с `ServerName`. Она должна выглядеть примерно так:

```
...
server_name documentat.io www.documentat.io;
...
```

Если она выглядит таким образом, закройте файл и переходите к следующему шагу.

Если она не выглядит так, как описано выше, обновите директиву `ServerName`. Затем сохраните и закройте файл, после чего проверьте корректность синтаксиса вашего конфигурационного файла командой:

```
$ sudo nginx -t
```

Если вы получили ошибку, откройте файл серверного блока и проверьте его на наличие опечаток или пропущенных символов. После того, как ваш конфигурационный файл будет проходить проверку на корректность, перезагрузите nginx для применения новой конфигурации:

```
$ sudo systemctl reload nginx
```

Теперь Certbot сможет найти правильный серверный блок и автоматически обновлять его.

Далее обновим настройки файрвола для пропуска HTTPS трафика.

## Шаг 3. Разрешение HTTPS в файрволе

Если у вас включен файрвол `ufw`, как рекомендуется в руководстве по первичной настройке сервера, вам необходимо внести некоторые изменения в его настройки для разрешения трафика HTTPS. Обычно при установке nginx регистрирует в `ufw` несколько профилей.

Вы можете ознакомиться с текущими настройками командой:

```
$ sudo ufw status
```

Скорее всего вывод будет выглядеть следующим образом:

```
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere                  
Nginx HTTP                 ALLOW       Anywhere                  
OpenSSH (v6)               ALLOW       Anywhere (v6)             
Nginx HTTP (v6)            ALLOW       Anywhere (v6)
```

Как видно из вывода, разрешён только трафик HTTP.

Чтобы разрешить трафик HTTPS, активируйте профиль `Nginx Full` и удалите лишний профиль `Nginx HTTP`:

```
$ sudo ufw allow 'Nginx Full'
$ sudo ufw delete allow 'Nginx HTTP'
```

Проверим внесённые изменения:

```
$ sudo ufw status
```

Теперь настройки `ufw` должны выглядеть следующим образом:

```
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere
Nginx Full                 ALLOW       Anywhere
OpenSSH (v6)               ALLOW       Anywhere (v6)
Nginx Full (v6)            ALLOW       Anywhere (v6)
```

Теперь мы можем запустить Certbot и получить сертификаты.

## Шаг 4. Получение SSL-сертификата

Certbot предоставляет несколько способов получения сертификатов SSL с использованием плагинов. Плагин для nginx изменит конфигурацию Nginx и перезагрузит ее, когда это потребуется. Для использования плагина выполним команду:

```
$ sudo certbot --nginx -d documentat.io -d www.documentat.io
```

Эта команда запускает `certbot` с плагином `--nginx`, ключи `d` определяют имена доменов, для которых должен быть выпущен сертификат.

Поскольку это первый раз, когда вы запустите `certbot`, вам будет предложено ввести адрес электронной почты и согласиться с условиями использования сервиса. После этого `certbot` свяжется с сервером Let’s Encrypt, а затем проверит, что вы действительно контролируете домен, для которого вы запросили сертификат.

Если всё прошло успешно, `certbot` спросит, как вы хотите настроить конфигурацию HTTPS.

```
Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: No redirect - Make no further changes to the webserver configuration.
2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for
new sites, or if you're confident your site works on HTTPS. You can undo this
change by editing your web server's configuration.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate number [1-2] then [enter] (press 'c' to cancel):
```

Выберите подходящий вариант и нажмите `ENTER`. Конфигурация будет обновлена, а nginx перезапущен для применения изменений. `certbot` выдаст сообщение о том, что процесс прошёл успешно, и где хранятся ваши сертификаты:

```
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/documentat.io/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/documentat.io/privkey.pem
   Your cert will expire on 2020-12-23. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot again
   with the "certonly" option. To non-interactively renew *all* of
   your certificates, run "certbot renew"
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
```

Ваши сертификаты загружены, установлены и работают. Попробуйте перезагрузить ваш сайт с использованием `https://` и вы увидите значок безопасности в браузере. Он означает, что соединение с сайтом зашифровано, обычно он выглядит, как зелёная иконка замка. Если вы проверите ваш сервер тестом [SSL Labs Server Test](https://www.ssllabs.com/ssltest/), он получит оценку **A**.

Закончим тестированием процесса обновления сертификата.

## Шаг 5. Проверка автоматического обновления сертификата

Сертификаты Let’s Encrypt действительны только 90 дней. Однако пакет certbot выполняет это автоматически, добавляя таймер `systemd`, который будет запускаться два раза в день и автоматически продлевать все сертификаты, истекающиее менее, чем через 30 дней.

Вы можете запросить статус таймера с помощью команды `systemctl`:

```
$ sudo systemctl status certbot.timer
```

Вывод покажет примерно следующее:

```
● certbot.timer - Run certbot twice daily
     Loaded: loaded (/lib/systemd/system/certbot.timer; enabled; vendor preset: enabled)
     Active: active (waiting) since Mon 2020-05-04 20:04:36 UTC; 2 weeks 1 days ago
    Trigger: Thu 2020-05-21 05:22:32 UTC; 9h left
   Triggers: ● certbot.service
```

Для тестирования процесса обновления мы можем сделать “сухой” запуск (dry run) **certbot**:

```
$ sudo certbot renew --dry-run
```

Если вы не видите каких-либо ошибок в результате выполнения этой команды, то всё в полном порядке. При необходимости Certbot будет обновлять ваши сертификаты и перезагружать nginx для применения изменений. Если автоматическое обновление по какой-либо причине закончится ошибкой, Let’s Encrypt отправит электронное письмо на указанный вами адрес электронной почты с информацией о сертификате, который скоро закончится.

