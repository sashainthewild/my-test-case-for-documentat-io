---
title: "Как включить HTTPS на вашем сайте c Apache с помощью Let’s Encrypt"
date: 2019-03-26T08:47:11+01:00
draft: false
---

# Как включить HTTPS на вашем сайте c Apache с помощью Let’s Encrypt

[Let’s Encrypt](https://letsencrypt.org/) представляет собой некоммерческий центр сертификации (Certificate Authority, CA), позволяющий бесплатно получать, устанавливать и обновлять сертификаты TLS/SSL. Процесс получения сертификатов упрощается за счёт наличия ACME-клиента Certbot, который автоматизирует практически все необходимые операции, в том числе и для Apache.

Несмотря на то, что SSL-сертификаты Let’s Encrypt бесплатны — это не означает, что уровень их шифрования ниже, чем у платных сертификатов. Let’s Encrypt придерживается самых высоких стандартов шифрования и предлагает сертификаты высокого уровня надежности.

## Чем сертификаты Let's Encrypt отличаются от платных сертификатов

**Стоимостью.** Let's Encrypt не потребует денег ни за установку ни за продление сертификата. Однако возможно сделать добровольное пожертвование на [сайте проекта](https://letsencrypt.org/ru/donate/).

**Скоростью и простотой установки.** Let's Encrypt в своей работе делает упор на автоматизацию абсолютно всех процессов. На типичном веб-сервере на базе Linux требуется выполнить несколько команд, которые настроят HTTPS-шифрование, получат и установят сертификат примерно за 20-30 секунд.

**Сроком действия.** Бесплатный сертификат Let’s Encrypt нельзя получить на год — только на 90 дней. Каждые три месяца его необходимо выпускать заново. Certbot поможет настроить автоматическое обновление.

**Совместимостью.** SSL-сертификаты Let’s Encrypt не работают в некоторых старых браузерах и операционных системах. Например, на компьютерах с Windows XP версии ниже SP3 или устройствах с Android версии ниже 2.3.6.

**Поддержкой.** У Let’s Encrypt нет службы поддержки, в которую можно обратиться, если появятся вопросы по установке или работе сертификата. Найти ответы можно в технической документации или на форуме. 


## Перед установкой

Перед тем, как начать следовать описанным в этой статье шагам, убедитесь, что:

+ на вашем сервере Ubuntu настроен доступ для не-рутового (non-root) пользователя с привилегиями `sudo` и доступом к настройке файрвола;

+ для вашего сервера настроены обе записи DNS, указанные ниже;

  + Запись `A` для `documentat.io`, указывающая на публичный IP адрес вашего сервера;
  + Запись `A` для `www.documentat.io`, указывающая на публичный IP адрес вашего сервера.

+ настроенный файл виртуального хоста для вашего домена. 

Для получения бесплатного SSL сертификата и настройки автоматического продления этого сертификата мы будем использовать Certbot.

Также мы будем использовать файл отдельного виртуального хоста Apache вместо дефолтного файла конфигурации. Мы рекомендуем создавать новые файлы виртуальных хостов Apache для каждого доменного имени. Это поможет избежать распространённых ошибок и использовать дефолтные файлы в качестве примера корректной конфигурации, если что-нибудь пойдёт не так.

В этом руководстве мы будем использовать `/etc/apache2/sites-available/documentat.io.conf`.

---

## Шаг 1. Установка Certbot

Перед началом использования Let’s Encrypt для получения SSL сертификаты установим Certbot на ваш сервер.

Certbot находится в активной разработке, поэтому пакеты Certbot, предоставляемые Ubuntu, обычно являются устаревшими. Тем не менее, разработчики Certbot поддерживают свой репозиторий пакетов для Ubuntu с актуальными версиями, поэтому мы будем использовать именно этот репозиторий.

Сначала добавим репозиторий:
```
$ sudo add-apt-repository ppa:certbot/certbot
```

Далее нажмите `ENTER`.

Установим пакет Certbot для Apache с помощью `apt`:
```
$ sudo apt install python-certbot-apache
```

Теперь Certbot готов к использованию, но для того, чтобы он мог настроить SSL для Apache, нам сперва необходимо проверить настройки Apache.

## Шаг 2. Настройка SSL сертификата

Certbot должен иметь возможность найти корректный виртуальный хост в вашей конфигурации Apache для того, чтобы автоматически конфигурировать SSL. Для этого он будет искать директиву `ServerName`, которая совпадает с доменным именем, для которого вы запросите сертификат.

Ваш виртуальный хост для вашего домена должен быть расположен по адресу `/etc/apache2/sites-available/documentat.io.conf` с уже правильно настроенной директивой `ServerName`.

Для проверки откройте файл конфигурации в nano или любом другом текстовом редакторе:
```
$ sudo nano /etc/apache2/sites-available/documentat.io.conf
```

Найдите строку с `ServerName`. Она должна выглядеть примерно так:
```
...
ServerName documentat.io;
...
```

Если она выглядит таким образом, закройте файл и переходите к следующему шагу.

Если она не выглядит так, как описано выше, обновите директиву `ServerName`. Затем сохраните и закройте файл, после чего проверьте корректность синтаксиса вашего конфигурационного файла командой:
```
$ sudo apache2ctl configtest
```

Если вы получили ошибку, откройте файл конфигурации и проверьте его на наличие опечаток или пропущенных символов. После того, как ваш конфигурационный файл будет проходить проверку на корректность, перезагрузите Apache для применения новой конфигурации:

```
$ sudo systemctl reload apache2
```

Теперь Certbot может находить и обновлять корректный виртуальный хост.

Далее обновим настройки файрвола для пропуска HTTPS трафика.

## Шаг 3. Разрешение HTTPS в файрволе

Если у вас включен файрвол `ufw`, как рекомендуется в руководстве по первичной настройке сервера, вам необходимо внести некоторые изменения в его настройки для разрешения трафика HTTPS. Обычо Apache регистрирует необходимые профили в `ufw` в момент установки.

Вы можете ознакомиться с текущими настройками командой:

```
$ sudo ufw status
```

Скорее всего вывод будет выглядеть следующим образом:
```
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere                  
Apache                     ALLOW       Anywhere                  
OpenSSH (v6)               ALLOW       Anywhere (v6)             
Apache (v6)                ALLOW       Anywhere (v6)
```

Как видно из вывода, разрешён только трафик HTTP.

Для того, чтобы разрешить трафик HTTPS, разрешим профиль `Apache Full` и удалим избыточный профиль `Apache`:

```
$ sudo ufw allow 'Apache Full'
$ sudo ufw delete allow 'Apache'
```

Проверим внесённые изменения:

```
$ sudo ufw status
```

Теперь настройки ufw должны выглядеть следующим образом:

```
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere                  
Apache Full                ALLOW       Anywhere                  
OpenSSH (v6)               ALLOW       Anywhere (v6)             
Apache Full (v6)           ALLOW       Anywhere (v6)  
```

Теперь мы можем запустить Certbot и получить сертификаты.

## Шаг 4. Получение SSL-сертификата

Certbot предоставляет несколько способов получения сертификатов SSL с использованием плагинов. Плагин для Apache берёт на себя настройку Apache и перезагрузку конфигурации, когда это необходимо. Для использования плагина выполним команду:

```
$ sudo certbot --apache -d example.com -d www.example.com
```

Эта команда запускает `certbot` с плагином `-apache`, ключи `d` определяют имена доменов, для которых должен быть выпущен сертификат.

Поскольку это первый раз, когда вы запустите `certbot`, вам будет предложено ввести адрес электронной почты и согласиться с условиями использования сервиса. После этого `certbot` свяжется с сервером Let’s Encrypt, а затем проверит, что вы действительно контролируете домен, для которого вы запросили сертификат.

Если всё прошло успешно, `certbot` спросит, как вы хотите настроить конфигурацию HTTPS.

```
Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
-------------------------------------------------------------------------------
1: No redirect - Make no further changes to the webserver configuration.
2: Redirect - Make all requests redirect to secure HTTPS access. Choose this for
new sites, or if you're confident your site works on HTTPS. You can undo this
change by editing your web server's configuration.
-------------------------------------------------------------------------------
Select the appropriate number [1-2] then [enter] (press 'c' to cancel):
```

Выберите подходящий вариант и нажмите `ENTER`. Конфигурация будет обновлена, а Apache перезапущен для применения изменений. **certbot** выдаст сообщение о том, что процесс прошёл успешно, и где хранятся ваши сертификаты:

```
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/documentat.io/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/documentat.io/privkey.pem
   Your cert will expire on 2020-12-23. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot again
   with the "certonly" option. To non-interactively renew *all* of
   your certificates, run "certbot renew"
 - Your account credentials have been saved in your Certbot
   configuration directory at /etc/letsencrypt. You should make a
   secure backup of this folder now. This configuration directory will
   also contain certificates and private keys obtained by Certbot so
   making regular backups of this folder is ideal.
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
```

Ваши сертификаты загружены, установлены и работают. Попробуйте перезагрузить ваш сайт с использованием `https://` и вы увидите значок безопасности в браузере. Он означает, что соединение с сайтом зашифровано, обычно он выглядит, как зелёная иконка замка. Если вы проверите ваш сервер тестом [SSL Labs Server Test](https://www.ssllabs.com/ssltest/), он получит оценку **A**.

Закончим тестированием процесса обновления сертификата.

## Шаг 5. Проверка автоматического обновления сертификата

Сертификаты Let’s Encrypt действительны только 90 дней. Однако пакет **certbot** самостоятельно обновляет их путём добавления скрипта обновления в `/etc/cron.d`. Этот скрипт запускается раз в день и автоматически обновляет любые сертификаты, которые закончатся в течение ближайших 30 дней.

Для тестирования процесса обновления мы можем сделать “сухой” запуск (dry run) **certbot**:

```
$ sudo certbot renew --dry-run
```

Если вы не видите каких-либо ошибок в результате выполнения этой команды, то всё в полном порядке. При необходимости Certbot будет обновлять ваши сертификаты и перезагружать Apache для применения изменений. Если автоматическое обновление по какой-либо причине закончится ошибкой, Let’s Encrypt отправит электронное письмо на указанный вами адрес электронной почты с информацией о сертификате, который скоро закончится.